import React, { useMemo, useState, useEffect } from "react";

/**
 * Customers page — self-contained beta build (no external UI libs, no missing imports)
 * - Inlines tiny UI primitives
 * - SSR-safe localStorage hook
 * - Includes light sanity checks
 */

/*********************** Tiny UI primitives ************************/
const Btn: React.FC<React.ButtonHTMLAttributes<HTMLButtonElement> & { variant?: 'primary'|'outline'|'danger'|'ghost', size?: 'sm'|'md'|'icon' }>=({variant='primary',size='md',className='',children,...rest})=> (
  <button {...rest} className={[
    'inline-flex items-center justify-center select-none border rounded-md transition-colors',
    variant==='primary' && 'bg-blue-600 text-white border-blue-700 hover:bg-blue-700',
    variant==='danger' && 'bg-red-600 text-white border-red-700 hover:bg-red-700',
    variant==='outline' && 'bg-white text-gray-900 border-gray-300 hover:bg-gray-50',
    variant==='ghost' && 'bg-transparent text-gray-900 border-transparent hover:bg-gray-50',
    size==='sm' ? 'h-8 px-2 text-sm' : size==='icon' ? 'h-8 w-8 p-0' : 'h-9 px-3',
    className
  ].filter(Boolean).join(' ')}>{children}</button>
);
const Input: React.FC<React.InputHTMLAttributes<HTMLInputElement>> = (p)=> <input {...p} className={["h-9 px-3 border rounded-md w-full", p.className||''].join(' ')} />;
const Label: React.FC<React.HTMLAttributes<HTMLLabelElement>> = ({className='',...rest})=> <label {...rest} className={["block text-sm font-medium text-gray-700", className].join(' ')} />;
const Card: React.FC<React.HTMLAttributes<HTMLDivElement>> = ({className='',...rest})=> <div {...rest} className={["border rounded-lg bg-white", className].join(' ')} />;
const CardBody: React.FC<React.HTMLAttributes<HTMLDivElement>> = ({className='',...rest})=> <div {...rest} className={["p-4", className].join(' ')} />;
const Badge: React.FC<{tone?:'ok'|'warn'|'danger'|'muted'|'bad'}> = ({tone='muted', children}) => {
  const map = { ok:'bg-green-100 text-green-800', warn:'bg-yellow-100 text-yellow-800', danger:'bg-red-100 text-red-800', muted:'bg-gray-100 text-gray-700', bad:'bg-red-100 text-red-800' } as const;
  return <span className={["text-xs px-2 py-0.5 rounded", map[tone]].join(' ')}>{children}</span>;
};

/*********************** Types & Data ************************/
export type Customer = { id: string; name: string; creditActive?: boolean };
const seedCustomers: Customer[] = [ { id: 'CUST-1001', name: 'Hudson Insights', creditActive: true } ];

/*********************** localStorage hook ************************/
function useLocalStorage<T>(key:string, seed:T){
  const isClient = () => typeof window !== 'undefined' && !!window.localStorage;
  const [value,setValue] = useState<T>(()=>{ if(!isClient()) return seed; try{ const raw=window.localStorage.getItem(key); return raw? JSON.parse(raw): seed; }catch{ return seed; } });
  useEffect(()=>{ if(!isClient()) return; try{ window.localStorage.setItem(key, JSON.stringify(value)); }catch{} },[key,value]);
  const save=(next:T)=>{ setValue(next); if(!isClient()) return; try{ window.localStorage.setItem(key, JSON.stringify(next)); }catch{} };
  return { value, save } as const;
}

/*********************** Customers View ************************/
export default function CustomersView(){
  const { value: customers, save } = useLocalStorage<Customer[]>("dp_customers", seedCustomers);
  const [editing, setEditing] = useState<Customer | undefined>();
  const [q, setQ] = useState("");

  const filtered = useMemo(() => (customers||[]).filter(c => (c.name||'').toLowerCase().includes(q.toLowerCase())), [customers, q]);

  const upsert = (c:Customer)=>{
    const exists = (customers||[]).some(x=>x.id===c.id);
    const next = exists? customers.map(x=> x.id===c.id? c: x): [c, ...customers];
    save(next);
  };
  const remove = (id:string)=> save((customers||[]).filter(x=>x.id!==id));

  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <h3 className="text-lg font-semibold">Customers</h3>
      </div>

      <Card>
        <CardBody className="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <Label>Search</Label>
            <Input value={q} onChange={e=>setQ(e.target.value)} />
          </div>
          <div className="self-end">
            <Btn onClick={()=> setEditing({ id: 'CUST-'+(Math.floor(Math.random()*9000)+1000), name:'', creditActive:true })}>+ New</Btn>
          </div>
        </CardBody>
      </Card>

      <Card>
        <CardBody className="p-0 overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-50">
              <tr>
                <th className="p-2 text-left">Name</th>
                <th className="p-2 text-left">Credit</th>
                <th className="p-2 text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {filtered.length? filtered.map(c=> (
                <tr key={c.id} className="odd:bg-white even:bg-gray-50">
                  <td className="p-2 font-medium">{c.name||'—'}</td>
                  <td className="p-2">{c.creditActive? <Badge>Active</Badge>: <Badge tone="bad">Inactive</Badge>}</td>
                  <td className="p-2 text-right">
                    <div className="flex justify-end gap-2">
                      <Btn variant="outline" size="sm" onClick={()=>setEditing(c)}>Edit</Btn>
                      <Btn variant="danger" size="sm" onClick={()=>remove(c.id)}>Delete</Btn>
                    </div>
                  </td>
                </tr>
              )): (
                <tr><td className="p-6 text-center text-gray-500" colSpan={3}>No customers.</td></tr>
              )}
            </tbody>
          </table>
        </CardBody>
      </Card>

      <EditCustomerDialog value={editing} onClose={()=>setEditing(undefined)} onSave={upsert}/>
    </div>
  );
}

function EditCustomerDialog({ value, onClose, onSave }:{ value?:Customer; onClose:()=>void; onSave:(c:Customer)=>void }){
  const [form,setForm]=useState<Customer|undefined>(value);
  useEffect(()=> setForm(value), [value]);
  if(!value) return null;
  const u=(k:keyof Customer, v:any)=> setForm(f=> ({...(f as Customer), [k]: v}));
  const commit=()=>{ onSave(form as Customer); onClose(); };
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/30" onClick={onClose}/>
      <Card className="relative w-full max-w-md">
        <CardBody className="space-y-3">
          <h4 className="font-semibold">Edit Customer</h4>
          <div>
            <Label>Name</Label>
            <Input value={form?.name||''} onChange={e=>u('name', e.target.value)} />
          </div>
          <div className="flex items-center gap-2">
            <Label>Credit Active</Label>
            <Btn variant="outline" onClick={()=>u('creditActive', !form?.creditActive)}>{form?.creditActive? 'Set Inactive':'Set Active'}</Btn>
          </div>
          <div className="flex justify-end gap-2">
            <Btn variant="ghost" onClick={onClose}>Cancel</Btn>
            <Btn onClick={commit}>Save</Btn>
          </div>
        </CardBody>
      </Card>
    </div>
  );
}

// Non-throwing sanity checks
try{
  const t: Customer = { id:'TEST', name:'Acme', creditActive:true };
  console.assert(typeof t.id==='string' && typeof t.name==='string', 'Customer type guard');
} catch {}
