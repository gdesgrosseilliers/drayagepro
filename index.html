<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DrayagePro TMS & WMS by Hudson Insights</title>
<!-- React + Babel (for in-browser JSX transpile; fine for beta/demo) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  :root {
    --bg: #ffffff;
    --fg: #111111;
    --muted: #666666;
    --line: #dcdcdc;
    --primary: #0a5bd3;
    --danger: #c62828;
    --warn: #b26a00;
    --ok: #2e7d32;
    --accent: #0a5bd3;
    --focus: #2b7cff;
  }
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body {
    margin:0;
    background: var(--bg);
    color: var(--fg);
    font: 14px/1.4 -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji", "Segoe UI Symbol";
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
  .toolbar, .row { display:flex; align-items:center; gap:8px; }
  .toolbar { justify-content: space-between; margin-bottom: 12px; }
  .hstack { display:flex; align-items:center; gap:8px; }
  .vstack { display:flex; flex-direction:column; gap:8px; }
  .title { font-weight:600; font-size:18px; }
  .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 12px; }
  .btn {
    border:1px solid var(--line);
    background:#fff;
    color:var(--fg);
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    min-height:34px;
  }
  .btn:hover { border-color:#c8c8c8; }
  .btn.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
  .btn.warn { background: #fff3cd; border-color:#ffe69c; }
  .btn.danger { background:#fff; border-color: var(--danger); color: var(--danger); }
  .btn[disabled] { opacity:.5; cursor:not-allowed; }
  .input, select, textarea {
    border:1px solid var(--line);
    background:#fff;
    padding:6px 8px;
    border-radius:6px;
    min-height:34px;
    width:100%;
  }
  .input:focus, select:focus, textarea:focus, .btn:focus {
    outline:2px solid var(--focus);
    outline-offset:1px;
  }
  .card { border:1px solid var(--line); border-radius:8px; background:#fff; }
  .card-body { padding:12px; }
  .grid { display:grid; gap:10px; }
  .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
  .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
  .grid.cols-4 { grid-template-columns: repeat(4, minmax(0,1fr)); }
  .table { width:100%; border-collapse:collapse; }
  .table th, .table td { padding:8px; border-bottom:1px solid var(--line); text-align:left; }
  .table th { font-size:12px; font-weight:600; }
  .table .right { text-align:right; }
  .muted { color: var(--muted); }
  .badge { font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:999px; }
  .badge.ok { color: var(--ok); border-color: var(--ok); }
  .badge.warn { color: var(--warn); border-color: var(--warn); }
  .badge.bad { color: var(--danger); border-color: var(--danger); }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; padding:16px; }
  .modal { background:#fff; border-radius:10px; border:1px solid var(--line); width:100%; max-width:980px; }
  .modal .hd { padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; }
  .modal .bd { padding:12px; }
  .sr { position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
  .section-title { font-weight:600; margin-top:8px; }
  .spacer { height:8px; }
</style>
</head>
<body>
<div id="app"></div>

<script type="text/babel">
/** ======= Tiny UI helpers ======= */
const {useState,useMemo,useEffect,useRef} = React;

const Btn = ({className="", variant, ...p}) =>
  <button {...p} className={["btn", variant||"", className].join(" ").trim()} />;

const Input = (p) => <input {...p} className={["input", p.className||""].join(" ")} />;
const NumberInput = (p) => <input {...p} inputMode="decimal" className={["input", p.className||""].join(" ")} />;
const TextArea = (p) => <textarea {...p} rows={p.rows||3} className={["input", p.className||""].join(" ")} />;

const Card = ({className="", ...p}) => <div {...p} className={["card", className].join(" ")} />;
const CardBody = ({className="", ...p}) => <div {...p} className={["card-body", className].join(" ")} />;
const Badge = ({tone, children}) => {
  const cls = tone==="ok" ? "ok" : tone==="warn" ? "warn" : tone==="bad" ? "bad" : "";
  return <span className={["badge", cls].join(" ")}>{children}</span>;
};
const Modal = ({open, onClose, title, children, wide}) => {
  if(!open) return null;
  return (
    <div className="modal-backdrop" onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}>
      <div className="modal" style={{maxWidth:wide?1160:980}}>
        <div className="hd">
          <div className="title">{title||""}</div>
          <Btn onClick={onClose}>Close</Btn>
        </div>
        <div className="bd">{children}</div>
      </div>
    </div>
  );
};

/** ======= Utilities & Types (JS doc only) ======= */
const isClient = () => typeof window !== "undefined" && !!window.localStorage;
const round2 = (n) => Math.round((Number(n)||0)*100)/100;
const money = (n) => round2(n||0).toFixed(2);
const parseMoney = (s) => {
  const t = String(s ?? "");
  const noCommas = t.split(",").join("");
  const quick = Number(noCommas);
  if (!Number.isNaN(quick) && Number.isFinite(quick)) return round2(quick);
  let out = "", seenDot = false;
  for (let i=0;i<noCommas.length;i++){
    const ch = noCommas[i];
    if ((ch>="0" && ch<="9") || (ch==="-" && out==="") || (ch==="." && !seenDot)) {
      out += ch;
      if (ch === ".") seenDot = true;
    }
  }
  const num = parseFloat(out || "0");
  return round2(Number.isFinite(num) ? num : 0);
};
const snapMoneyBlur = (e) => { try{ e.target.value = money(parseMoney(e.target.value)); } catch {} };

const termsList = ["Pre-pay","Pay Upon Delivery","Net-30","Net-45","Net-60"];
const hazmatClasses = [
  "1 Explosives","2 Gases","3 Flammable Liquid and Combustible Liquid",
  "4 Flammable Solid, Spontaneously Combustible and Dangerous When Wet",
  "5 Oxidizer and Organic Peroxide","6 Poison (Toxic) and Poison Inhalation Hazard",
  "7 Radioactive","8 Corrosive","9 Miscellaneous Hazardous Materials"
];
const BILLABLE_TYPES = ["Linehaul","Fuel","Detention","Accessorial","Lumper","Chassis","Stopoff","Storage","Waiting","Other"];
const defaultWarehouse = "Acme Transportation University Park - 2545 Palmer Ave, University Park, IL 60484";

/** ======= localStorage hook ======= */
function useLocalStorage(key, seed){
  const [value, setValue] = React.useState(()=>{
    if(!isClient()) return seed;
    try {
      const raw = window.localStorage.getItem(key);
      return raw ? JSON.parse(raw) : seed;
    } catch { return seed; }
  });
  React.useEffect(()=>{
    if(!isClient()) return;
    try { window.localStorage.setItem(key, JSON.stringify(value)); } catch {}
  }, [key, value]);
  return { value, save:setValue };
}

/** ======= Seeds ======= */
const seedUsers = [{ username:"g.desgrosseilliers", password:"Lincoln082024", role:"admin" }];

const seedCustomers = [{
  id:"CUST-1001", name:"Hudson Insights",
  creditTerms:"Net-30", creditLimit: 100000, availableCredit: 100000, totalBalance:0,
  apContact:{ name:"", phone:"", email:"", address:"", methods:[] },
  opsContact:{ name:"", phone:"", email:"", address:"" },
  docs:{ creditAppUrl:"", billingInstrUrl:"" }
}];

const seedCarriers = [{
  id:"CAR-2001", name:"Windy City Drayage", mc:"123456", dot:"7654321",
  arContact:{ name:"", email:"", phone:"", address:"" }
}];

const seedLoads = [{
  id:"LOAD-3001", ref:"PO-7781", customerId:"CUST-1001", carrierId:"CAR-2001",
  mode:"Dray", trade:"Import",
  origin:"CN-LBT Pier E", stop1:"UP Global 1", destination:"CIC Chicago",
  pickup:"2025-10-18",
  arrivalDate:"2025-10-18", lastFreeDay:"2025-10-21", dispatchDate:"2025-10-18", deliveryDate:"2025-10-20", deliveryTime:"14:00",
  status:"Active", equipment:"Container", containerNo:"MSCU1234567", chassisNo:"CH-0091",
  hazmat:false, hazmatClass:"", tankerEndorsed:false,
  weightLbs: 38500, shipmentValue: 75000,
  billables:[{ id:"B1", type:"Linehaul", description:"Linehaul", note:"", carrier:550, customer:775 },
             { id:"B2", type:"Fuel", description:"Fuel", note:"Auto", carrier:50, customer:75 }]
}];

const seedInvoices = [{
  id:"INV-9001", ref:"LOAD-3001", customer:"Hudson Insights",
  status:"Draft", invoiceDate:"", taxPct:0, discount:0,
  lines:[{id:"L1",type:"Linehaul",description:"Load charge",note:"Auto",amount:775},
         {id:"L2",type:"Fuel",description:"Surcharge",note:"Auto",amount:75}],
  total: 850
}];

const seedStorage = [{
  id:"STO-5001", customerId:"CUST-1001", warehouse: defaultWarehouse,
  units:10, unitDescription:"Pallets",
  weightLbs: 12000, valueUSD: 35000,
  dailyRate: 12.5, isHazmat:false, hazmatClass:"",
}];

/** ======= Auth ======= */
function useAuth(){
  const usersLS = useLocalStorage("dp_users", seedUsers);
  const [session, setSession] = React.useState(()=>{
    return isClient()? window.localStorage.getItem("dp_session"): null;
  });
  const current = (usersLS.value||[]).find(u=>u.username === session) || null;
  const login = (u,p)=>{
    const uname = (u||"").trim().toLowerCase();
    const hit = (usersLS.value||[]).find(x=>x.username.trim().toLowerCase()===uname && x.password===p);
    if(hit){ if(isClient()) window.localStorage.setItem("dp_session", hit.username); setSession(hit.username); return {ok:true}; }
    return {ok:false};
  };
  const logout = ()=>{ if(isClient()) window.localStorage.removeItem("dp_session"); setSession(null); };
  const requireAdmin = ()=> current && current.role==="admin";
  return { users:usersLS.value, setUsers:usersLS.save, current, login, logout, requireAdmin };
}

/** ======= Data stores ======= */
function useStore(){
  const customers = useLocalStorage("dp_customers", seedCustomers);
  const carriers  = useLocalStorage("dp_carriers", seedCarriers);
  const loads     = useLocalStorage("dp_loads", seedLoads);
  const invoices  = useLocalStorage("dp_invoices", seedInvoices);
  const storage   = useLocalStorage("dp_storage", seedStorage);
  return { customers, carriers, loads, invoices, storage };
}

/** ======= Credit helpers ======= */
const loadCustomerTotal = (load) => round2((load.billables||[]).reduce((s,b)=>s+(Number(b.customer)||0),0));
function debitCreditForLoad(customersLS, load){
  const cust = (customersLS.value||[]).find(c=>c.id===load.customerId);
  if(!cust) return;
  const amt = loadCustomerTotal(load);
  const next = {...cust, availableCredit: round2((cust.availableCredit||0) - amt), totalBalance: round2((cust.totalBalance||0) + amt)};
  customersLS.save((customersLS.value||[]).map(c=>c.id===cust.id? next: c));
}
function restoreCreditForInvoice(customersLS, invoicesLS, inv){
  const cust = (customersLS.value||[]).find(c=>c.name===inv.customer);
  if(!cust) return;
  const amt = Number(inv.total)||0;
  const next = {...cust, availableCredit: round2((cust.availableCredit||0) + amt), totalBalance: round2((cust.totalBalance||0) - amt)};
  customersLS.save((customersLS.value||[]).map(c=>c.id===cust.id? next: c));
  invoicesLS.save((invoicesLS.value||[]).map(i=>i.id===inv.id? {...i}: i));
}

/** ======= CSV & Print helpers ======= */
const createCSV = (rows)=>{
  if(!rows?.length) return "";
  const headers = Object.keys(rows[0]);
  const esc = (v)=> '"' + String(v??"").split('"').join('""') + '"';
  return [headers.join(","), ...rows.map(r=>headers.map(k=>esc(r[k])).join(","))].join("
");
};
const csvDownload = (rows, name)=>{
  const csv = createCSV(rows);
  if(!csv) return;
  const url = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8;"}));
  const a = document.createElement("a"); a.href=url; a.download=name+".csv"; a.click(); URL.revokeObjectURL(url);
};
function openPrintHTML(title, parts){
  try{
    const w = window.open("about:blank","_blank"); if(!w) return;
    w.document.write("<!doctype html><title>"+title+"</title><body style='font-family:Segoe UI,Arial; padding:16px;'>");
    parts.forEach(p=>w.document.write(p));
    w.document.write("</body>");
    w.document.close(); w.focus(); w.print();
  }catch{}
}
function printInvoicePDF(inv, setInvoiceDate){
  if(!inv.invoiceDate){ inv.invoiceDate = new Date().toISOString().slice(0,10); if(setInvoiceDate) setInvoiceDate(inv.invoiceDate); }
  const rows = (inv.lines||[]).map(l=>(
    "<tr><td>"+(l.type||"")+"</td><td>"+(l.description||"")+"</td><td>"+(l.note||"")+"</td><td style='text-align:right'>$"+money(l.amount||0)+"</td></tr>"
  )).join("");
  const parts = [];
  parts.push("<h2>Invoice "+inv.id+"</h2>");
  parts.push("<div><b>Customer:</b> "+(inv.customer||"")+"</div>");
  if(inv.ref) parts.push("<div><b>Ref:</b> "+inv.ref+"</div>");
  if(inv.invoiceDate) parts.push("<div><b>Invoice Date:</b> "+inv.invoiceDate+"</div>");
  parts.push("<table border='1' cellspacing='0' cellpadding='6' style='margin-top:8px; width:100%; border-collapse:collapse; font-size:12px;'>"+
             "<thead><tr><th>Type</th><th>Description</th><th>Note</th><th>Amount</th></tr></thead><tbody>"+rows+"</tbody></table>");
  parts.push("<h3 style='text-align:right'>Total: $"+money(inv.total||0)+"</h3>");
  parts.push("<div style='margin-top:12px; color:#888'>Created in DrayagePro TMS by Hudson Insights</div>");
  openPrintHTML(inv.id, parts);
}

/** ======= Login ======= */
const LoginView = ({onSuccess})=>{
  const {login} = useAuth();
  const [u,setU] = React.useState(""); const [p,setP] = React.useState(""); const [busy,setBusy]=React.useState(false); const [msg,setMsg]=React.useState("");
  const submit = ()=>{
    if(busy) return;
    setBusy(true);
    const r = login(u,p);
    if(r.ok){ onSuccess(); } else { setMsg("Invalid credentials"); setBusy(false); }
  };
  return (
    <div className="container" style={{minHeight:"70vh", display:"flex", alignItems:"center", justifyContent:"center"}}>
      <Card style={{width:360}}>
        <CardBody>
          <div className="title" style={{marginBottom:6}}>Sign in</div>
          <div className="vstack">
            <div>
              <label className="section-title">Username</label>
              <Input value={u} onChange={e=>setU(e.target.value)} onKeyDown={e=>e.key==="Enter"&&submit()} placeholder="username"/>
            </div>
            <div>
              <label className="section-title">Password</label>
              <Input type="password" value={p} onChange={e=>setP(e.target.value)} onKeyDown={e=>e.key==="Enter"&&submit()} placeholder="password"/>
            </div>
            {msg? <div className="muted" style={{color:"#c62828"}}>{msg}</div>: null}
            <Btn className="primary" onClick={submit} disabled={busy}>{busy? "Signing in..." : "Sign In"}</Btn>
          </div>
        </CardBody>
      </Card>
    </div>
  );
};

/** ======= Loads (TMS) ======= */
const lifecycle = ["Active","Tendered","Dispatched","Picked-up","Delivered","Returned Empty","Invoiced"];

const LoadBoard = ({store, auth, onOpenDetail})=>{
  const {customers, carriers, loads} = store;
  const cname = (id)=> ((customers.value||[]).find(c=>c.id===id)||{}).name || "—";
  const carname = (id)=> ((carriers.value||[]).find(c=>c.id===id)||{}).name || "—";

  const [q,setQ] = React.useState("");
  const filtered = React.useMemo(()=>{
    const key = q.trim().toLowerCase();
    if(!key) return loads.value||[];
    return (loads.value||[]).filter(s=>{
      const fields = [s.id,s.ref,s.origin,s.stop1,s.destination,s.equipment,s.containerNo, cname(s.customerId), carname(s.carrierId)];
      return fields.some(x=>String(x||"").toLowerCase().includes(key));
    });
  }, [q, loads.value]);

  const addNew = ()=>{
    const nid = "LOAD-"+(Math.floor(Math.random()*9000)+1000);
    onOpenDetail({
      id:nid, ref:"", customerId: (customers.value?.[0]?.id)||"", carrierId: "",
      mode:"Dray", trade:"Import",
      origin:"", stop1:"", destination:"",
      pickup:new Date().toISOString().slice(0,10),
      arrivalDate:"", lastFreeDay:"", dispatchDate:"", deliveryDate:"", deliveryTime:"",
      status:"Active", equipment:"Container", containerNo:"", chassisNo:"",
      hazmat:false, hazmatClass:"", tankerEndorsed:false,
      weightLbs:0, shipmentValue:0,
      billables:[{id:"B"+(Math.floor(Math.random()*9000)+1000), type:"Linehaul", description:"Linehaul", note:"", carrier:0, customer:0}]
    }, true);
  };

  const sum = (xs)=> xs.reduce((a,b)=>a+b,0);

  return (
    <div className="vstack">
      <div className="toolbar">
        <div className="title">Load Board</div>
        <div className="hstack">
          <Input placeholder="Search..." value={q} onChange={(e)=>setQ(e.target.value)} style={{width:260}}/>
          <Btn className="primary" onClick={addNew}>+ New Load</Btn>
          <Btn onClick={()=>csvDownload(filtered,"loads")}>Export CSV</Btn>
        </div>
      </div>
      <Card>
        <CardBody>
          <table className="table">
            <thead>
              <tr>
                <th>Load #</th>
                <th>Origin</th>
                <th>Stop #1</th>
                <th>Destination/Return Location</th>
                <th>Carrier</th>
                <th>Weight (lbs)</th>
                <th>Commodity</th>
                <th>Container Size</th>
                <th>Arrival</th>
                <th>LFD</th>
                <th>Dispatch</th>
                <th>Delivery (Date/Time)</th>
                <th className="right">Carrier $</th>
                <th className="right">Customer $</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {filtered.length? filtered.map(s=>{
                const totals = {
                  carr: round2(sum((s.billables||[]).map(b=>Number(b.carrier)||0))),
                  cust: round2(sum((s.billables||[]).map(b=>Number(b.customer)||0))),
                };
                return (
                  <tr key={s.id}>
                    <td><a href="#" onClick={(e)=>{e.preventDefault(); onOpenDetail(s,false);}}>{s.id}</a></td>
                    <td>{s.origin||"—"}</td>
                    <td>{s.stop1||"—"}</td>
                    <td>{s.destination||"—"}</td>
                    <td>{carname(s.carrierId)}</td>
                    <td>{s.weightLbs||0}</td>
                    <td>{s.commodity||"—"}</td>
                    <td>{s.containerSize||"—"}</td>
                    <td>{s.arrivalDate||"—"}</td>
                    <td>{s.lastFreeDay||"—"}</td>
                    <td>{s.dispatchDate||"—"}</td>
                    <td>{(s.deliveryDate||"—") + (s.deliveryTime? " "+s.deliveryTime:"")}</td>
                    <td className="right">${money(totals.carr)}</td>
                    <td className="right">${money(totals.cust)}</td>
                    <td>{(()=>{
                      const t = (s.status||"").toLowerCase();
                      const tone = t==="delivered" ? "ok" : t==="tendered" || t==="dispatched" || t==="picked-up" ? "warn" :
                                   t==="returned empty" || t==="invoiced" ? "" : "";
                      return <Badge tone={tone||""}>{s.status}</Badge>;
                    })()}</td>
                  </tr>
                );
              }):(
                <tr><td colSpan="15" className="muted">No loads.</td></tr>
              )}
            </tbody>
          </table>
        </CardBody>
      </Card>
    </div>
  );
};

const EditLoad = ({open, value, onClose, onSave, store, auth})=>{
  const {customers, carriers, invoices} = store;
  const [form,setForm] = React.useState(value);
  React.useEffect(()=>{ setForm(value); },[value]);
  if(!open||!form) return null;
  const u=(k,v)=> setForm({...form,[k]:v});
  const moneyCell=(val, on)=> <NumberInput defaultValue={money(val)} onBlur={snapMoneyBlur} onChange={(e)=>on(parseMoney(e.target.value))}/>;
  const addLine=(type)=> u("billables", [...(form.billables||[]), {id:"B"+(Math.floor(Math.random()*9000)+1000), type:type||"Linehaul", description:type||"Linehaul", note:"", carrier:0, customer:0}]);
  const delLine=(id)=> u("billables", (form.billables||[]).filter(b=>b.id!==id));
  const sum = (xs)=> xs.reduce((a,b)=>a+b,0);

  const doSave = ()=>{
    const custTotal = round2(sum((form.billables||[]).map(b=>Number(b.customer)||0)));
    const customer = (customers.value||[]).find(c=>c.id===form.customerId);
    if(customer){
      const wouldAvail = round2((customer.availableCredit||0) - custTotal);
      if(wouldAvail < 0 && (!auth.current || auth.current.role!=="admin")){
        alert("Insufficient available credit for this customer. Ask an admin to approve or increase credit.");
        return;
      }
    }
    onSave(form);
    onClose();
  };

  return (
    <Modal open={open} onClose={onClose} title={"Load Detail • "+form.id} wide>
      <div className="grid cols-3">
        <div>
          <label className="section-title">Customer</label>
          <select className="input" value={form.customerId} onChange={e=>u("customerId", e.target.value)}>
            {(customers.value||[]).map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div>
          <label className="section-title">Carrier</label>
          <select className="input" value={form.carrierId||""} onChange={e=>u("carrierId", e.target.value||"")}>
            <option value="">—</option>
            {(carriers.value||[]).map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div>
          <label className="section-title">Lifecycle</label>
          <select className="input" value={form.status} onChange={e=>u("status", e.target.value)}>
            {lifecycle.map(s=><option key={s}>{s}</option>)}
          </select>
        </div>

        <div>
          <label className="section-title">Mode</label>
          <select className="input" value={form.mode} onChange={e=>u("mode", e.target.value)}>
            <option>Dray</option><option>TL</option><option>LTL</option><option>Parcel</option>
          </select>
        </div>
        {form.mode==="Dray" && (
          <>
            <div>
              <label className="section-title">Import/Export</label>
              <select className="input" value={form.trade||"Import"} onChange={e=>u("trade", e.target.value)}>
                <option>Import</option><option>Export</option>
              </select>
            </div>
            <div>
              <label className="section-title">Tanker Endorsed</label>
              <div className="hstack">
                <input type="checkbox" checked={!!form.tankerEndorsed} onChange={e=>u("tankerEndorsed", e.target.checked)}/>
                <span className="muted">Driver requires tanker endorsement</span>
              </div>
            </div>
          </>
        )}

        <div>
          <label className="section-title">Origin</label>
          <Input value={form.origin||""} onChange={e=>u("origin", e.target.value)} />
        </div>
        <div>
          <label className="section-title">Stop #1</label>
          <Input value={form.stop1||""} onChange={e=>u("stop1", e.target.value)} />
        </div>
        <div>
          <label className="section-title">Destination/Return Location</label>
          <Input value={form.destination||""} onChange={e=>u("destination", e.target.value)} />
        </div>

        <div>
          <label className="section-title">Arrival Date</label>
          <Input type="date" value={form.arrivalDate||""} onChange={e=>u("arrivalDate", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Last Free Day</label>
          <Input type="date" value={form.lastFreeDay||""} onChange={e=>u("lastFreeDay", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Dispatch Date</label>
          <Input type="date" value={form.dispatchDate||""} onChange={e=>u("dispatchDate", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Delivery Date</label>
          <Input type="date" value={form.deliveryDate||""} onChange={e=>u("deliveryDate", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Delivery Time</label>
          <Input type="time" value={form.deliveryTime||""} onChange={e=>u("deliveryTime", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Equipment</label>
          <Input value={form.equipment||""} onChange={e=>u("equipment", e.target.value)} />
        </div>

        <div>
          <label className="section-title">Container #</label>
          <Input value={form.containerNo||""} onChange={e=>u("containerNo", e.target.value)} />
        </div>
        <div>
          <label className="section-title">Chassis #</label>
          <Input value={form.chassisNo||""} onChange={e=>u("chassisNo", e.target.value)} />
        </div>
        <div>
          <label className="section-title">Container Size</label>
          <Input value={form.containerSize||""} onChange={e=>u("containerSize", e.target.value)} />
        </div>

        <div>
          <label className="section-title">Weight (lbs)</label>
          <NumberInput defaultValue={String(form.weightLbs||0)} onBlur={(e)=>{ e.target.value=String(parseInt(e.target.value||"0",10)||0); }} onChange={e=>u("weightLbs", parseInt(e.target.value||"0",10)||0)} />
        </div>
        <div>
          <label className="section-title">Shipment Value (USD)</label>
          <NumberInput defaultValue={money(form.shipmentValue||0)} onBlur={snapMoneyBlur} onChange={e=>u("shipmentValue", parseMoney(e.target.value))}/>
        </div>
        <div>
          <label className="section-title">Commodity</label>
          <Input value={form.commodity||""} onChange={e=>u("commodity", e.target.value)} />
        </div>

        <div>
          <label className="section-title">Hazmat</label>
          <div className="hstack">
            <input type="checkbox" checked={!!form.hazmat} onChange={e=>u("hazmat", e.target.checked)}/>
            <span className="muted">Check if hazardous</span>
          </div>
        </div>
        <div>
          <label className="section-title">Hazmat Class</label>
          <select className="input" value={form.hazmatClass||""} onChange={e=>u("hazmatClass", e.target.value)} disabled={!form.hazmat}>
            <option value="">—</option>
            {hazmatClasses.map(x=><option key={x}>{x}</option>)}
          </select>
        </div>
      </div>

      <div className="spacer"></div>
      <div className="section-title">Billables</div>
      <div className="hstack" style={{justifyContent:"space-between", marginBottom:6}}>
        <div className="hstack">
          <select className="input" style={{width:220}} defaultValue="" onChange={(e)=>{ if(e.target.value){ addLine(e.target.value); e.target.value=""; } }}>
            <option value="">Quick add...</option>
            {BILLABLE_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
          </select>
          <Btn onClick={()=>addLine("Linehaul")}>+ Line</Btn>
        </div>
        <div className="muted">Totals update on save.</div>
      </div>
      <table className="table">
        <thead>
          <tr>
            <th>Type</th><th>Description</th><th>Note</th>
            <th className="right">Carrier $</th><th className="right">Customer $</th><th className="right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {(form.billables||[]).map((b,i)=>(
            <tr key={b.id}>
              <td>
                <select className="input" value={b.type} onChange={e=>{
                  const copy=[...(form.billables||[])]; copy[i]={...b,type:e.target.value}; u("billables", copy);
                }}>
                  {BILLABLE_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
                </select>
              </td>
              <td><Input value={b.description||""} onChange={e=>{ const copy=[...(form.billables||[])]; copy[i]={...b,description:e.target.value}; u("billables", copy); }}/></td>
              <td><Input value={b.note||""} onChange={e=>{ const copy=[...(form.billables||[])]; copy[i]={...b,note:e.target.value}; u("billables", copy); }}/></td>
              <td className="right"><NumberInput defaultValue={money(b.carrier||0)} onBlur={snapMoneyBlur} onChange={e=>{
                const copy=[...(form.billables||[])]; copy[i]={...b,carrier:parseMoney(e.target.value)}; u("billables", copy);
              }}/></td>
              <td className="right"><NumberInput defaultValue={money(b.customer||0)} onBlur={snapMoneyBlur} onChange={e=>{
                const copy=[...(form.billables||[])]; copy[i]={...b,customer:parseMoney(e.target.value)}; u("billables", copy);
              }}/></td>
              <td className="right"><Btn className="danger" onClick={()=>delLine(b.id)}>Del</Btn></td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="hstack" style={{justifyContent:"flex-end", marginTop:10}}>
        <Btn onClick={onClose}>Cancel</Btn>
        <Btn className="primary" onClick={doSave}>Save</Btn>
      </div>
    </Modal>
  );
};

/** ======= Carriers ======= */
const CarriersView = ({store})=>{
  const {carriers} = store;
  const [q,setQ]=React.useState("");
  const [editing,setEditing]=React.useState(null);
  const filtered = React.useMemo(()=>{
    const s=q.trim().toLowerCase();
    return (carriers.value||[]).filter(c=>{
      const fields=[c.name,c.mc,c.dot].map(x=>String(x||"").toLowerCase());
      return !s || fields.some(v=>v.includes(s));
    });
  },[q,carriers.value]);

  const upsert=(c)=>{
    const list=[...(carriers.value||[])];
    const i=list.findIndex(x=>x.id===c.id);
    if(i>=0) list[i]=c; else list.unshift(c);
    carriers.save(list);
  };
  const remove=(id)=> carriers.save((carriers.value||[]).filter(c=>c.id!==id));

  return (
    <div className="vstack">
      <div className="toolbar">
        <div className="title">Carriers</div>
        <div className="hstack">
          <Input placeholder="Search Name / MC# / DOT#" value={q} onChange={e=>setQ(e.target.value)} style={{width:280}}/>
          <Btn className="primary" onClick={()=>setEditing({id:"CAR-"+(Math.floor(Math.random()*9000)+1000), name:"", mc:"", dot:"", arContact:{name:"",email:"",phone:"",address:""}})}>+ New Carrier</Btn>
        </div>
      </div>
      <Card><CardBody>
        <table className="table">
          <thead>
            <tr><th>Name</th><th>MC#</th><th>DOT#</th><th>AR Contact</th><th className="right">Actions</th></tr>
          </thead>
        <tbody>
          {filtered.length? filtered.map(c=>(
            <tr key={c.id}>
              <td>{c.name||"—"}</td>
              <td>{c.mc||"—"}</td>
              <td>{c.dot||"—"}</td>
              <td>
                {(c.arContact?.name||"—")}{c.arContact?.email? " • "+c.arContact.email:""}{c.arContact?.phone? " • "+c.arContact.phone:""}
              </td>
              <td className="right">
                <div className="hstack" style={{justifyContent:"flex-end"}}>
                  <Btn onClick={()=>setEditing(c)}>Edit</Btn>
                  <Btn className="danger" onClick={()=>remove(c.id)}>Del</Btn>
                </div>
              </td>
            </tr>
          )): <tr><td colSpan="5" className="muted">No carriers.</td></tr>}
        </tbody>
        </table>
      </CardBody></Card>
      <EditCarrier open={!!editing} value={editing} onClose={()=>setEditing(null)} onSave={upsert}/>
    </div>
  );
};
const EditCarrier = ({open,value,onClose,onSave})=>{
  const [form,setForm]=React.useState(value);
  React.useEffect(()=>setForm(value),[value]);
  if(!open||!form) return null;
  const u=(k,v)=>setForm({...form,[k]:v});
  const uAR=(k,v)=>setForm({...form, arContact:{...(form.arContact||{}), [k]:v}});
  const save=()=>{ onSave(form); onClose(); };
  return (
    <Modal open={open} onClose={onClose} title={"Edit Carrier • "+form.id}>
      <div className="grid cols-3">
        <div className="grid cols-3" style={{gridColumn:"1 / -1", gap:10}}>
          <div style={{gridColumn:"1 / -1"}}>
            <label className="section-title">Name</label>
            <Input value={form.name||""} onChange={e=>u("name", e.target.value)}/>
          </div>
          <div>
            <label className="section-title">MC#</label>
            <Input value={form.mc||""} onChange={e=>u("mc", e.target.value)}/>
          </div>
          <div>
            <label className="section-title">DOT#</label>
            <Input value={form.dot||""} onChange={e=>u("dot", e.target.value)}/>
          </div>
        </div>

        <div style={{gridColumn:"1 / -1"}} className="section-title">Accounts Receivable Contact</div>
        <div>
          <label className="section-title">Name</label>
          <Input value={form.arContact?.name||""} onChange={e=>uAR("name", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Email</label>
          <Input value={form.arContact?.email||""} onChange={e=>uAR("email", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Phone</label>
          <Input value={form.arContact?.phone||""} onChange={e=>uAR("phone", e.target.value)}/>
        </div>
        <div style={{gridColumn:"1 / -1"}}>
          <label className="section-title">Address</label>
          <Input value={form.arContact?.address||""} onChange={e=>uAR("address", e.target.value)}/>
        </div>
      </div>
      <div className="hstack" style={{justifyContent:"flex-end", marginTop:10}}>
        <Btn onClick={onClose}>Cancel</Btn>
        <Btn className="primary" onClick={save}>Save</Btn>
      </div>
    </Modal>
  );
};

/** ======= Customers ======= */
const CustomersView = ({store})=>{
  const {customers} = store;
  const [q,setQ]=React.useState("");
  const [editing,setEditing]=React.useState(null);
  const filtered = React.useMemo(()=>{
    const s=q.trim().toLowerCase();
    return (customers.value||[]).filter(c=>!s || String(c.name||"").toLowerCase().includes(s));
  },[q,customers.value]);
  const upsert=(c)=>{
    const list=[...(customers.value||[])];
    const i=list.findIndex(x=>x.id===c.id);
    if(i>=0) list[i]=c; else list.unshift(c);
    customers.save(list);
  };
  return (
    <div className="vstack">
      <div className="toolbar">
        <div className="title">Customers</div>
        <div className="hstack">
          <Input placeholder="Search..." value={q} onChange={e=>setQ(e.target.value)} style={{width:260}}/>
          <Btn className="primary" onClick={()=>setEditing({
            id:"CUST-"+(Math.floor(Math.random()*9000)+1000), name:"", creditTerms:"Net-30",
            creditLimit:0, availableCredit:0, totalBalance:0,
            apContact:{name:"",phone:"",email:"",address:"",methods:[]},
            opsContact:{name:"",phone:"",email:"",address:""},
            docs:{creditAppUrl:"", billingInstrUrl:""}
          })}>+ New Customer</Btn>
        </div>
      </div>
      <Card><CardBody>
        <table className="table">
          <thead><tr>
            <th>Name</th><th>Terms</th><th>Available Credit</th><th>Total Balance</th><th className="right">Actions</th>
          </tr></thead>
          <tbody>
            {filtered.length? filtered.map(c=>(
              <tr key={c.id}>
                <td>{c.name}</td>
                <td>{c.creditTerms}</td>
                <td>${money(c.availableCredit||0)}</td>
                <td>${money(c.totalBalance||0)}</td>
                <td className="right">
                  <div className="hstack" style={{justifyContent:"flex-end"}}>
                    <Btn onClick={()=>setEditing(c)}>Edit</Btn>
                  </div>
                </td>
              </tr>
            )): <tr><td colSpan="5" className="muted">No customers.</td></tr>}
          </tbody>
        </table>
      </CardBody></Card>
      <EditCustomer open={!!editing} value={editing} onClose={()=>setEditing(null)} onSave={upsert}/>
    </div>
  );
};
const EditCustomer = ({open,value,onClose,onSave})=>{
  const [form,setForm]=React.useState(value);
  React.useEffect(()=>setForm(value),[value]);
  if(!open||!form) return null;
  const u=(k,v)=>setForm({...form,[k]:v});
  const uAP=(k,v)=>setForm({...form, apContact:{...(form.apContact||{}), [k]:v}});
  const uOps=(k,v)=>setForm({...form, opsContact:{...(form.opsContact||{}), [k]:v}});
  const uDocs=(k,v)=>setForm({...form, docs:{...(form.docs||{}), [k]:v}});
  const toggleMethod=(m)=>{
    const cur=new Set(form.apContact?.methods||[]);
    if(cur.has(m)) cur.delete(m); else cur.add(m);
    uAP("methods", Array.from(cur));
  };
  const save=()=>{ onSave(form); onClose(); };
  return (
    <Modal open={open} onClose={onClose} title={"Edit Customer • "+form.id} wide>
      <div className="grid cols-3">
        <div style={{gridColumn:"1 / -1"}}>
          <label className="section-title">Name</label>
          <Input value={form.name||""} onChange={e=>u("name", e.target.value)}/>
        </div>

        <div>
          <label className="section-title">Credit Terms</label>
          <select className="input" value={form.creditTerms||"Net-30"} onChange={e=>u("creditTerms", e.target.value)}>
            {termsList.map(t=><option key={t}>{t}</option>)}
          </select>
        </div>
        <div>
          <label className="section-title">Credit Limit (USD)</label>
          <NumberInput defaultValue={money(form.creditLimit||0)} onBlur={snapMoneyBlur} onChange={e=>u("creditLimit", parseMoney(e.target.value))}/>
        </div>
        <div>
          <label className="section-title">Available Credit (USD)</label>
          <NumberInput defaultValue={money(form.availableCredit||0)} onBlur={snapMoneyBlur} onChange={e=>u("availableCredit", parseMoney(e.target.value))}/>
        </div>
        <div>
          <label className="section-title">Total Balance (USD)</label>
          <NumberInput defaultValue={money(form.totalBalance||0)} onBlur={snapMoneyBlur} onChange={e=>u("totalBalance", parseMoney(e.target.value))}/>
        </div>

        <div style={{gridColumn:"1 / -1"}} className="section-title">Accounts Payable</div>
        <div><label className="section-title">Contact Name</label><Input value={form.apContact?.name||""} onChange={e=>uAP("name", e.target.value)}/></div>
        <div><label className="section-title">Phone</label><Input value={form.apContact?.phone||""} onChange={e=>uAP("phone", e.target.value)}/></div>
        <div><label className="section-title">E-Mail</label><Input value={form.apContact?.email||""} onChange={e=>uAP("email", e.target.value)}/></div>
        <div style={{gridColumn:"1 / -1"}}><label className="section-title">Mailing Address</label><Input value={form.apContact?.address||""} onChange={e=>uAP("address", e.target.value)}/></div>
        <div style={{gridColumn:"1 / -1"}} className="hstack">
          <span className="section-title">Preferred Invoice Method:</span>
          {["Mail","E-Mail","Fax"].map(m=>(
            <label key={m} className="hstack" style={{gap:6}}>
              <input type="checkbox" checked={(form.apContact?.methods||[]).includes(m)} onChange={()=>toggleMethod(m)}/>
              <span>{m}</span>
            </label>
          ))}
        </div>

        <div style={{gridColumn:"1 / -1"}} className="section-title">Operations / Tender Authority</div>
        <div><label className="section-title">Contact Name</label><Input value={form.opsContact?.name||""} onChange={e=>uOps("name", e.target.value)}/></div>
        <div><label className="section-title">Phone</label><Input value={form.opsContact?.phone||""} onChange={e=>uOps("phone", e.target.value)}/></div>
        <div><label className="section-title">E-Mail</label><Input value={form.opsContact?.email||""} onChange={e=>uOps("email", e.target.value)}/></div>
        <div style={{gridColumn:"1 / -1"}}><label className="section-title">Mailing / Office Address</label><Input value={form.opsContact?.address||""} onChange={e=>uOps("address", e.target.value)}/></div>

        <div style={{gridColumn:"1 / -1"}} className="section-title">Documents</div>
        <div>
          <label className="section-title">Credit Application URL</label>
          <Input placeholder="https://..." value={form.docs?.creditAppUrl||""} onChange={e=>uDocs("creditAppUrl", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Billing Instructions URL</label>
          <Input placeholder="https://..." value={form.docs?.billingInstrUrl||""} onChange={e=>uDocs("billingInstrUrl", e.target.value)}/>
        </div>
      </div>

      <div className="hstack" style={{justifyContent:"flex-end", marginTop:10}}>
        <Btn onClick={onClose}>Cancel</Btn>
        <Btn className="primary" onClick={()=>{ onSave(form); onClose(); }}>Save</Btn>
      </div>
    </Modal>
  );
};

/** ======= Billing ======= */
const BillingView = ({store, auth})=>{
  const {invoices, customers} = store;
  const [q,setQ]=React.useState(""); const [editing,setEditing]=React.useState(null); const [flt,setFlt]=React.useState("All");
  const filtered = React.useMemo(()=>{
    const s=q.trim().toLowerCase();
    return (invoices.value||[]).filter(inv=>{
      const passStatus = (flt==="All") || (inv.status===flt);
      const fields=[inv.id,inv.ref,inv.customer].map(x=>String(x||"").toLowerCase());
      return passStatus && (!s || fields.some(v=>v.includes(s)));
    });
  },[q,flt,invoices.value]);

  const badgeTone=(s)=> s==="Paid" ? "ok" : s==="Sent" ? "warn" : s==="Void" ? "bad" : "";

  const upsert=(inv)=>{
    const list=[...(invoices.value||[])];
    const i=list.findIndex(x=>x.id===inv.id);
    if(i>=0) list[i]=inv; else list.unshift(inv);
    invoices.save(list);
  };
  const remove=(id)=> invoices.save((invoices.value||[]).filter(i=>i.id!==id));

  const ageDays = (inv)=>{
    if(!inv.invoiceDate) return 0;
    const d = new Date(inv.invoiceDate+"T00:00:00");
    const now=new Date();
    return Math.max(0, Math.floor((now - d)/(1000*60*60*24)));
  };

  return (
    <div className="vstack">
      <div className="toolbar">
        <div className="title">Billing</div>
        <div className="hstack">
          <Input placeholder="Search..." value={q} onChange={e=>setQ(e.target.value)} style={{width:260}}/>
          <select className="input" value={flt} onChange={e=>setFlt(e.target.value)} style={{width:140}}>
            {["All","Draft","Sent","Paid","Void"].map(s=><option key={s}>{s}</option>)}
          </select>
          <Btn onClick={()=>csvDownload(filtered,"invoices")}>Export CSV</Btn>
          <Btn className="primary" onClick={()=>setEditing({
            id:"INV-"+(Math.floor(Math.random()*900000)+100000),
            ref:"", customer:(customers.value?.[0]?.name)||"",
            status:"Draft", invoiceDate:"", taxPct:0, discount:0, total:0,
            lines:[{id:"L"+(Math.floor(Math.random()*9000)+1000), type:"Linehaul", description:"Charge", note:"", amount:0}]
          })}>+ New Invoice</Btn>
        </div>
      </div>
      <Card><CardBody>
        <table className="table">
          <thead><tr>
            <th>ID</th><th>Customer</th><th>Ref</th><th>Status</th><th>Invoice Date</th><th>Aging (days)</th><th className="right">Total</th><th className="right">Actions</th>
          </tr></thead>
          <tbody>
            {filtered.length? filtered.map(inv=>(
              <tr key={inv.id}>
                <td>{inv.id}</td>
                <td>{inv.customer}</td>
                <td>{inv.ref||"—"}</td>
                <td><Badge tone={badgeTone(inv.status)}>{inv.status}</Badge></td>
                <td>{inv.invoiceDate||"—"}</td>
                <td>{(inv.status==="Paid"||inv.status==="Void")? 0 : ageDays(inv)}</td>
                <td className="right">${money(inv.total||0)}</td>
                <td className="right">
                  <div className="hstack" style={{justifyContent:"flex-end"}}>
                    <Btn onClick={()=>setEditing(inv)} disabled={inv.status!=="Draft"}>Edit</Btn>
                    <Btn onClick={()=>{
                      const setDate=(d)=>{ upsert({...inv, invoiceDate:d}); };
                      printInvoicePDF(inv,setDate);
                    }} disabled={inv.status==="Void"}>PDF</Btn>
                    <Btn className="danger" onClick={()=>remove(inv.id)}>Del</Btn>
                  </div>
                </td>
              </tr>
            )): <tr><td colSpan="8" className="muted">No invoices.</td></tr>}
          </tbody>
        </table>
      </CardBody></Card>
      <EditInvoice open={!!editing} value={editing} onClose={()=>setEditing(null)} onSave={(inv)=>{
        const prev = editing?.status;
        if(prev!=="Paid" && inv.status==="Paid" && auth.requireAdmin()){
          restoreCreditForInvoice(customers, invoices, inv);
        }
        upsert(inv);
      }}/>
    </div>
  );
};
const EditInvoice = ({open,value,onClose,onSave})=>{
  const [form,setForm]=React.useState(value);
  React.useEffect(()=>setForm(value),[value]);
  if(!open||!form) return null;
  const u=(k,v)=>setForm({...form,[k]:v});
  const addLine=(type)=> u("lines", [...(form.lines||[]), {id:"L"+(Math.floor(Math.random()*9000)+1000), type:type||"Linehaul", description:type||"Linehaul", note:"", amount:0}]);
  const delLine=(id)=> u("lines", (form.lines||[]).filter(l=>l.id!==id));
  const setAmt=(i,v)=>{ const copy=[...(form.lines||[])]; copy[i]={...copy[i], amount:v}; u("lines", copy); };
  const subtotal = (form.lines||[]).reduce((t,l)=>t+(Number(l.amount)||0),0);
  const total = round2(subtotal + ((form.taxPct||0)/100)*subtotal - (Number(form.discount)||0));
  React.useEffect(()=>{ u("total", total); /* eslint-disable-next-line */ }, [subtotal, form.taxPct, form.discount]);

  const save=()=>{ onSave(form); onClose(); };

  return (
    <Modal open={open} onClose={onClose} title={"Edit Invoice • "+form.id} wide>
      <div className="grid cols-3">
        <div><label className="section-title">Customer</label><Input value={form.customer} onChange={e=>u("customer", e.target.value)}/></div>
        <div><label className="section-title">Reference (Load)</label><Input value={form.ref||""} onChange={e=>u("ref", e.target.value)}/></div>
        <div>
          <label className="section-title">Status</label>
          <select className="input" value={form.status} onChange={e=>u("status", e.target.value)}>
            <option>Draft</option><option>Sent</option><option>Paid</option><option>Void</option>
          </select>
        </div>
        <div>
          <label className="section-title">Invoice Date</label>
          <Input type="date" value={form.invoiceDate||""} onChange={e=>u("invoiceDate", e.target.value)}/>
        </div>
      </div>

      <div className="spacer"></div>
      <div className="hstack" style={{justifyContent:"space-between", marginBottom:6}}>
        <div className="section-title">Lines</div>
        <div className="hstack">
          <select className="input" style={{width:220}} defaultValue="" onChange={(e)=>{ if(e.target.value){ addLine(e.target.value); e.target.value=""; } }}>
            <option value="">Quick add...</option>
            {BILLABLE_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
          </select>
          <Btn onClick={()=>addLine("Linehaul")}>+ Line</Btn>
        </div>
      </div>
      <table className="table">
        <thead><tr><th>Type</th><th>Description</th><th>Note</th><th className="right">Amount</th><th className="right">Actions</th></tr></thead>
        <tbody>
          {(form.lines||[]).map((l,i)=>(
            <tr key={l.id}>
              <td>
                <select className="input" value={l.type} onChange={e=>{
                  const copy=[...(form.lines||[])]; copy[i]={...l, type:e.target.value}; u("lines", copy);
                }}>
                  {BILLABLE_TYPES.map(t=><option key={t} value={t}>{t}</option>)}
                </select>
              </td>
              <td><Input value={l.description||""} onChange={e=>{ const copy=[...(form.lines||[])]; copy[i]={...l, description:e.target.value}; u("lines", copy); }}/></td>
              <td><Input value={l.note||""} onChange={e=>{ const copy=[...(form.lines||[])]; copy[i]={...l, note:e.target.value}; u("lines", copy); }}/></td>
              <td className="right"><NumberInput defaultValue={money(l.amount||0)} onBlur={snapMoneyBlur} onChange={e=>setAmt(i, parseMoney(e.target.value))}/></td>
              <td className="right"><Btn className="danger" onClick={()=>delLine(l.id)}>Del</Btn></td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="grid cols-3" style={{marginTop:10}}>
        <div>
          <label className="section-title">Tax %</label>
          <NumberInput defaultValue={String(form.taxPct??0)} onBlur={snapMoneyBlur} onChange={e=>u("taxPct", parseMoney(e.target.value))}/>
        </div>
        <div>
          <label className="section-title">Discount $</label>
          <NumberInput defaultValue={money(form.discount||0)} onBlur={snapMoneyBlur} onChange={e=>u("discount", parseMoney(e.target.value))}/>
        </div>
        <div style={{alignSelf:"end", textAlign:"right", fontWeight:600}}>Total: ${money(total)}</div>
      </div>

      <div className="hstack" style={{justifyContent:"flex-end", marginTop:10}}>
        <Btn onClick={onClose}>Cancel</Btn>
        <Btn className="primary" onClick={save} disabled={form.status!=="Draft"}>Save</Btn>
      </div>
    </Modal>
  );
};

/** ======= WMS: Storage Orders ======= */
const WMSView = ({store})=>{
  const {storage, customers} = store;
  const [q,setQ]=React.useState(""); const [editing,setEditing]=React.useState(null);
  const filtered = React.useMemo(()=>{
    const s=q.trim().toLowerCase();
    const cname=(id)=> ((customers.value||[]).find(c=>c.id===id)||{}).name || "—";
    return (storage.value||[]).filter(o=>{
      const fields=[o.id, cname(o.customerId), o.warehouse, o.unitDescription, o.hazmatClass].map(x=>String(x||"").toLowerCase());
      return !s || fields.some(v=>v.includes(s));
    });
  },[q,storage.value,customers.value]);
  const upsert=(o)=>{
    const list=[...(storage.value||[])];
    const i=list.findIndex(x=>x.id===o.id);
    if(i>=0) list[i]=o; else list.unshift(o);
    storage.save(list);
  };
  const cname=(id)=> ((customers.value||[]).find(c=>c.id===id)||{}).name || "—";

  return (
    <div className="vstack">
      <div className="toolbar">
        <div className="title">WMS • Storage Orders</div>
        <div className="hstack">
          <Input placeholder="Search..." value={q} onChange={e=>setQ(e.target.value)} style={{width:260}}/>
          <Btn className="primary" onClick={()=>setEditing({
            id:"STO-"+(Math.floor(Math.random()*9000)+1000), customerId:(customers.value?.[0]?.id)||"",
            warehouse: defaultWarehouse, units:0, unitDescription:"Pallets", weightLbs:0, valueUSD:0,
            dailyRate:0, isHazmat:false, hazmatClass:""
          })}>+ New Storage Order</Btn>
        </div>
      </div>
      <Card><CardBody>
        <table className="table">
          <thead><tr>
            <th>ID</th><th>Customer</th><th>Warehouse</th><th>Units</th><th>Unit Desc</th><th>Weight (lbs)</th><th>Value (USD)</th><th>Hazmat</th><th>Daily $</th><th className="right">Actions</th>
          </tr></thead>
          <tbody>
            {filtered.length? filtered.map(o=>(
              <tr key={o.id}>
                <td>{o.id}</td>
                <td>{cname(o.customerId)}</td>
                <td>{o.warehouse}</td>
                <td>{o.units||0}</td>
                <td>{o.unitDescription||"—"}</td>
                <td>{o.weightLbs||0}</td>
                <td>${money(o.valueUSD||0)}</td>
                <td>{o.isHazmat? (o.hazmatClass||"Yes") : "No"}</td>
                <td>${money(o.dailyRate||0)}</td>
                <td className="right">
                  <div className="hstack" style={{justifyContent:"flex-end"}}>
                    <Btn onClick={()=>setEditing(o)}>Edit</Btn>
                  </div>
                </td>
              </tr>
            )): <tr><td colSpan="10" className="muted">No storage orders.</td></tr>}
          </tbody>
        </table>
      </CardBody></Card>
      <EditStorage open={!!editing} value={editing} onClose={()=>setEditing(null)} onSave={upsert} store={store}/>
    </div>
  );
};
const EditStorage = ({open,value,onClose,onSave,store})=>{
  const {customers} = store;
  const [form,setForm]=React.useState(value);
  React.useEffect(()=>setForm(value),[value]);
  if(!open||!form) return null;
  const u=(k,v)=>setForm({...form,[k]:v});
  const save=()=>{ onSave(form); onClose(); };
  return (
    <Modal open={open} onClose={onClose} title={"Edit Storage • "+form.id}>
      <div className="grid cols-3">
        <div>
          <label className="section-title">Customer</label>
          <select className="input" value={form.customerId} onChange={e=>u("customerId", e.target.value)}>
            {(customers.value||[]).map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
          </select>
        </div>
        <div style={{gridColumn:"2 / -1"}}>
          <label className="section-title">Warehouse</label>
          <Input value={form.warehouse||defaultWarehouse} onChange={e=>u("warehouse", e.target.value)}/>
        </div>
        <div>
          <label className="section-title">Units</label>
          <NumberInput defaultValue={String(form.units||0)} onBlur={(e)=>{ e.target.value=String(parseInt(e.target.value||"0",10)||0); }} onChange={e=>u("units", parseInt(e.target.value||"0",10)||0)} />
        </div>
        <div>
          <label className="section-title">Unit Description</label>
          <Input value={form.unitDescription||""} onChange={e=>u("unitDescription", e.target.value)} placeholder="Pallets, barrels, totes, etc."/>
        </div>
        <div>
          <label className="section-title">Weight (lbs)</label>
          <NumberInput defaultValue={String(form.weightLbs||0)} onBlur={(e)=>{ e.target.value=String(parseInt(e.target.value||"0",10)||0); }} onChange={e=>u("weightLbs", parseInt(e.target.value||"0",10)||0)} />
        </div>
        <div>
          <label className="section-title">Value (USD)</label>
          <NumberInput defaultValue={money(form.valueUSD||0)} onBlur={snapMoneyBlur} onChange={e=>u("valueUSD", parseMoney(e.target.value))}/>
        </div>
        <div>
          <label className="section-title">Daily Storage $</label>
          <NumberInput defaultValue={money(form.dailyRate||0)} onBlur={snapMoneyBlur} onChange={e=>u("dailyRate", parseMoney(e.target.value))}/>
        </div>
        <div>
          <label className="section-title">Hazmat</label>
          <div className="hstack">
            <input type="checkbox" checked={!!form.isHazmat} onChange={e=>u("isHazmat", e.target.checked)}/>
            <span className="muted">Check if hazardous</span>
          </div>
        </div>
        <div>
          <label className="section-title">Hazmat Class</label>
          <select className="input" value={form.hazmatClass||""} onChange={e=>u("hazmatClass", e.target.value)} disabled={!form.isHazmat}>
            <option value="">—</option>
            {hazmatClasses.map(x=><option key={x}>{x}</option>)}
          </select>
        </div>
      </div>
      <div className="hstack" style={{justifyContent:"flex-end", marginTop:10}}>
        <Btn onClick={onClose}>Cancel</Btn>
        <Btn className="primary" onClick={save}>Save</Btn>
      </div>
    </Modal>
  );
};

/** ======= App ======= */
const App = ()=>{
  const auth = useAuth();
  const store = useStore();
  const [tab,setTab] = React.useState("loads"); // start on Loads
  const [editingLoad, setEditingLoad] = React.useState(null);

  const upsertLoad = (load, isNew)=>{
    const list=[...(store.loads.value||[])];
    const i=list.findIndex(x=>x.id===load.id);
    if(i>=0) list[i]=load; else list.unshift(load);
    store.loads.save(list);

    if(isNew){
      debitCreditForLoad(store.customers, load);
      const lines = (load.billables||[]).length
        ? load.billables.map((b,idx)=>({id:"L"+(Math.floor(Math.random()*9000)+1000)+"-"+(idx+1), type:b.type||"Charge", description:b.description||("Load "+load.id), note:"Auto from load", amount: round2(Number(b.customer)||0)}))
        : [{id:"L"+(Math.floor(Math.random()*9000)+1000), type:"Linehaul", description:"Load "+load.id, note:"Auto", amount:0}];
      const total = round2(lines.reduce((t,l)=>t+(Number(l.amount)||0),0));
      store.invoices.save([{id:"INV-"+(Math.floor(Math.random()*900000)+100000), ref:load.id, customer:(store.customers.value||[]).find(c=>c.id===load.customerId)?.name||"", status:"Draft", invoiceDate:"", taxPct:0, discount:0, total, lines}, ...(store.invoices.value||[])]);
    } else {
      const listInv=[...(store.invoices.value||[])];
      const j=listInv.findIndex(x=>x.ref===load.id);
      if(j>=0 && listInv[j].status==="Draft"){
        const lines = (load.billables||[]).map((b,idx)=>({id:"L"+(Math.floor(Math.random()*9000)+1000)+"-"+(idx+1), type:b.type||"Charge", description:b.description||("Load "+load.id), note:"Auto from load", amount: round2(Number(b.customer)||0)}));
        const total = round2(lines.reduce((t,l)=>t+(Number(l.amount)||0),0));
        listInv[j] = {...listInv[j], customer:(store.customers.value||[]).find(c=>c.id===load.customerId)?.name||"", lines, total};
        store.invoices.save(listInv);
      }
    }
  };

  if(!auth.current) return <LoginView onSuccess={()=>setTab("loads")}/>;

  return (
    <div className="container">
      <div className="toolbar">
        <div className="title">DrayagePro TMS & WMS by Hudson Insights</div>
        <div className="hstack">
          <span className="muted">Signed in as <b>{auth.current.username}</b> ({auth.current.role||"user"})</span>
          <Btn onClick={auth.logout}>Logout</Btn>
        </div>
      </div>

      <div className="tabs">
        <Btn className={tab==="loads"?"primary":""} onClick={()=>setTab("loads")}>Load Board</Btn>
        <Btn className={tab==="carriers"?"primary":""} onClick={()=>setTab("carriers")}>Carriers</Btn>
        <Btn className={tab==="customers"?"primary":""} onClick={()=>setTab("customers")}>Customers</Btn>
        <Btn className={tab==="billing"?"primary":""} onClick={()=>setTab("billing")}>Billing</Btn>
        <Btn className={tab==="wms"?"primary":""} onClick={()=>setTab("wms")}>WMS</Btn>
      </div>

      {tab==="loads" && <LoadBoard store={store} auth={auth} onOpenDetail={(load,isNew)=>setEditingLoad({...load,__isNew:isNew})} />}
      {tab==="carriers" && <CarriersView store={store}/>}
      {tab==="customers" && <CustomersView store={store}/>}
      {tab==="billing" && <BillingView store={store} auth={auth}/>}
      {tab==="wms" && <WMSView store={store}/>}

      <EditLoad
        open={!!editingLoad}
        value={editingLoad||null}
        onClose={()=>setEditingLoad(null)}
        auth={auth}
        store={store}
        onSave={(s)=> upsertLoad(s, !!editingLoad?.__isNew)}
      />
    </div>
  );
};

ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
</script>
</body>
</html>
